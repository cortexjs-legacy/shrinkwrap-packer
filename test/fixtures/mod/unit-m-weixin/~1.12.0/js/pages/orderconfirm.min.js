define("unit-m-weixin@~1.12.0/js/modules/orderconfirm/content/controller",["./view","backbone@~1.1.0","marionette@~1.4.0","underscore@~1.5.0","../../../entities/getuserprofilegn"],function(e,t,n){var i=e("./view"),o=e("backbone"),r=(new o.Router,e("marionette")),s=e("underscore");n.exports=r.Controller.extend({initialize:function(e){this.orderId=e.orderId||0},show:function(t){var n=JSON.parse(localStorage.orderConfirm);this.UserProfilegnModel=e("../../../entities/getuserprofilegn").UserModel,this.userProfilegnModel=new this.UserProfilegnModel(n),this.view=new i({model:this.userProfilegnModel}),this.userProfilegnModel.on("change",s.bind(function(){n=s.extend(n,{enPay:this.userProfilegnModel.get("balance")-n.paymentamount>0?0:parseFloat(n.paymentamount-this.userProfilegnModel.get("balance")).toFixed(2)}),this.userProfilegnModel.set("data",n),t.show(this.view),this.view.discountPlay()},this))},getView:function(){return this.view}})},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@~1.12.0/js/modules/orderconfirm/layout.html",[],function(e,t,n){n.exports='<div class="J_cnt"><div class="loading" style="height:300px;"></div></div>'},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@~1.12.0/js/modules/orderconfirm/content/view",["marionette@~1.4.0","backbone@~1.1.0","wepp@~2.7.0","underscore@~1.5.0","zepto-wepp@~1.1.0","./template.html"],function(e,t,n){var i=e("marionette"),o=e("backbone"),r=(e("wepp").Url,e("wepp").UI),s=new o.Router,a=e("underscore"),d=e("zepto-wepp");n.exports=i.ItemView.extend({template:a.template(e("./template.html")),tagName:"div",events:{"touchstart .J_orderconfirm_submit":"orderConfrimSend"},initialize:function(){this.discountPrice=0},orderConfrimSend:function(e){e.preventDefault();var t=this,n=t.model,i=n.get("paymentType").length&&n.get("paymentType")[0]||{id:!1},o=n.get("paymentamount"),a=i.id;t.discountId&&n.get("canUseDiscount")&&(o=parseFloat(o-t.discountPrice>0?o-t.discountPrice:0).toFixed(2),a=o>0?a:""),n.get("canUseBalance")&&n.get("balance")&&(o=parseFloat(o-n.get("balance")>0?o-n.get("balance"):0).toFixed(2),a=o>0?a:""),d(".J_orderconfirm_submit").addClass("hide"),d(".J_un_orderconfirm_submit").removeClass("hide"),d.ajax({url:"/ajax/tuan/confirmordergn.json?"+(new Date).valueOf(),type:"POST",dataType:"json",data:{channel:"weixin",dealid:n.get("groupId"),orderid:n.get("orderId"),paymentamount:o,paymenttype:a,discountid:t.discountId||""},success:function(e){var t=e.data;if(d(".J_orderconfirm_submit").removeClass("hide"),d(".J_un_orderconfirm_submit").addClass("hide"),200==e.code)if(0==t.flag)s.navigate("#paysuc~"+n.get("orderId"),!0);else{var i=navigator.userAgent.match(/MicroMessenger\/([^\.]+)/);if(i&&parseInt(i[1])>4){var o=JSON.parse(t.content);WeixinJSBridge.invoke("getBrandWCPayRequest",o,function(e){"get_brand_wcpay_request:ok"==e.err_msg?s.navigate("#paysuc~"+n.get("orderId"),!0):r.alert("get_brand_wcpay_request:cancel"==e.err_msg?"支付取消":"支付失败")})}else r.alert("您的微信版本过低，不能使用支付功能，请升级客户端版本。")}else r.alert(t.content)}})},discountPlay:function(){var e=this,t=this.model;t.get("canUseDiscount")?(d(".J_discount_mes").html(t.get("discountList")&&0!=t.get("discountList").length?"有可用优惠":""),ThisApp.commands.setHandler("order::promo::update",function(n){if(n){d(".J_discount_mes").html(n.title).removeClass("Right");var i=t.get("data").enPay-(n.priceStr||0);d(".J_pay").html(i>0?parseFloat(i>0?i:0).toFixed(2):0),i>0||d(".J_payment_ofter").addClass("hide"),e.discountPrice=n.priceStr,e.discountId=n.id}else d(".J_discount_mes").addClass("Right").html("选择优惠类型"),d(".J_pay").html(t.get("data").enPay),e.discountPrice=0,t.get("data").enPay>0&&d(".J_payment_ofter").removeClass("hide"),e.discountId=""})):(d(".J_discount_href").attr("href","javascript:void(0)"),d(".J_discount_mes").html("本单不可使用"))}})},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@~1.12.0/js/entities/getuserprofilegn",["backbone@~1.1.0"],function(e,t){var n=e("backbone"),i=n.Model.extend({url:"/ajax/tuan/tuanprofilegn.json?",initialize:function(){this.fetch()},parse:function(e){var t=e.data;return{phone:t.mobilePhone,userId:t.userId,balance:t.balance,nickName:t.nickName,couponCount:t.couponCount,receiptCount:t.unusedReceiptCount,orderCount:t.unpayedOrderCount,code:e.code}}});t.UserModel=i},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@~1.12.0/js/modules/orderconfirm/content/template.html",[],function(e,t,n){n.exports='<div class="Box"><h5><%= title %></h5><div class="order-box"><ul><li>数量：<span class="infor Right"><%= count %></span></li><li>总价：<span class="Right">¥<%= paymentamount %></span></li></ul></div></div><div class="Box"><div class="order-box"><ul><li><span class="info">我的余额：</span><span class="Right">¥<%= balance %></span></li><li class="no-p "><a onclick="ThisApp.mv({module:\'cashier_coupon\'})" class="fill arrow J_discount_href" href="#promo~<%= orderId%>"><span class="tip">抵用券/优惠代码：</span><span class="mes J_discount_mes Right"></span><i class="arrow-ent right arrow-pos d"></i></a></li><li><div class="dz"><span class="tip">还需支付：</span><strong class="price J_pay Clear Right">¥<%= data.enPay %></strong></div></li></ul></div></div><div class="Box"><a onclick="ThisApp.mv({module:\'cashier_topay\'})" href="javascript:void(0)"  class="y-btn J_orderconfirm_submit" name="" style="width:95%;margin:0 auto;">确认订单，付款</a><a href="javascript:void(0)"  class="n-btn J_un_orderconfirm_submit hide" name="" style="width:95%;margin:0 auto;">正在处理</a></div><div style="height:50px;width:100%"></div>'},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@~1.12.0/js/pages/orderconfirm",["zepto-wepp@~1.1.0","underscore@~1.5.0","marionette@~1.4.0","../modules/orderconfirm/content/controller","../modules/orderconfirm/layout.html"],function(e,t){var n=(e("zepto-wepp"),e("underscore")),i=e("marionette"),o=e("../modules/orderconfirm/content/controller"),r=i.Controller.extend({show:function(t){var i=this;i.OrderConfirmController=new o({orderId:t}),ThisApp.openPage().then(function(t){t.initRegion({template:n.template(e("../modules/orderconfirm/layout.html")),regions:{header:".J_header",content:".J_cnt"}}),i.OrderConfirmController.show(t.layout.content)})}});t.Controller=r},{asyncDeps:["iscroll@~5.0.9"]});