define("unit-m-weixin@~1.12.0/js/modules/receiptlist/list/controller",["backbone@~1.1.0","./template.html","underscore@~1.5.0","zepto-wepp@~1.1.0","marionette@~1.4.0","../../../entities/receiptlist"],function(e,t,i){var s=e("backbone").View.extend({template:e("./template.html"),tagName:"ul"}),n=e("underscore"),l=e("zepto-wepp"),r=e("marionette"),o=e("../../../entities/receiptlist"),a=l(window);i.exports=r.Controller.extend({initialize:function(e){var t=e.page;delete e.page,e.start=e.start||0;var i=this;i.paramModel=new o.ParamModel(e);var n=i.collection=new o.ReceiptCollection(i.paramModel);n.clearCache();i.view=new s({collection:n});n.on("reset",this.renderList,this),this.listenToNext(),this.listHeight=0,this.resetHtml=!0,this._isEnd=!0,a.on("scroll",function(){ThisApp.pageRegion.isCurrentPage(t)&&a.scrollTop()+a.height()>i.listHeight-60&&i.more()})},setHeight:function(){this.listHeight=this.region.$el.get(0).offsetHeight},show:function(e){this.region=e},isEnd:function(){return this._isEnd},next:function(){return this._next},listenToNext:function(){this.collection.on("sync",function(e,t){this._isEnd=t.data.isEnd,this._next=t.data.nextStartIndex,this._isEnd&&this.hideLoad()},this)},restart:function(){this.collection.paramModel.set({start:0,force:Math.random()}),this.resetHtml=!0},more:function(){this.isEnd()||(this.showLoad(),this.collection.paramModel.set({start:this.next()}),this.resetHtml=!1)},showLoad:function(){this.view.$el.parent().next().css("visibility","visible")},hideLoad:function(){this.view.$el.parent().next().css("visibility","hidden")},renderList:function(){var e=this.collection,t=this.view,i=this.region;if(i.ensureEl(),!e.models.length&&this.resetHtml)return void i.$el.html('<p class="msg">您没有未使用的团购券</p>');var s="";e.toJSON().forEach(function(e){s+=n.template(t.template,e)}),t.$el[this.resetHtml?"html":"append"](s),i.$el.empty().append(t.$el),this.setHeight()}})},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@~1.12.0/js/modules/receiptlist/layout.html",[],function(e,t,i){i.exports='<div class="receipt-list"><div class="loading" style="height:200px;"></div></div><div class="more-loading" style="visibility:hidden">正在加载...</div>'},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@~1.12.0/js/modules/receiptlist/list/template.html",[],function(e,t,i){i.exports='<li><a href="#receiptdetail~<%= id %>" class="item<% if(type == 1) { %> unused<% } %>"><% if(type == 1) { %><div class="remain">剩余<span class="day"><strong><%= day %></strong>天</span></div><% } %><div class="info"><h3 class="title"><%= title %></h3><% if(type == 1) { %><p>序列号 <span class="num"><%= num %></span></p><% } %><p class="expire"><%= date %></p></div></a></li>'},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@~1.12.0/js/entities/receiptlist",["backbone@~1.1.0","underscore@~1.5.0"],function(e,t){var i=e("backbone"),s=window.localStorage,n=i.Model.extend({}),l=(e("underscore"),i.Collection.extend({initialize:function(e){this.paramModel=e,this.paramModel.on("change",this.showList,this),this.paramModel.trigger("change")},model:n,baseUrl:"/ajax/tuan/couponlistgn.json?",setUrl:function(){this.url=this.baseUrl+"start="+(this.paramModel.get("start")||0)+"&filter="+this.paramModel.get("type")+"&r="+Math.random()},parse:function(e){if(200==e.code){this.type=this.paramModel.get("type");var t,i=this,n=e.data.list||[],l=n.map(function(e){var t={type:i.type,id:e.id,day:i.getDay(e.clientDate),title:e.title,num:e.serialNumberPair?i.getSerialNum(e.serialNumberPair.name):"",date:i.getDate(e.clientDate),relativeId:e.relativeDeal.id,imageUrl:e.relativeDeal.imageUrl,orderId:e.orderId,refund:e.relativeDeal?e.relativeDeal.refund:!1};return i.collectionArr.push(t),t});try{t=JSON.parse(s.getItem("receiptCollection"))||[]}catch(r){t=[]}return s.setItem("receiptCollection",JSON.stringify(t.concat(this.collectionArr))),l}401==e.code},getSerialNum:function(e){for(var t=e.length,i=parseInt(t/4),s="",n=0;i>n;n++)s+=e.substring(4*n,4*(n+1)),s+=" ";return s+=e.substring(4*n,t)},getDate:function(e){var t=new Date(e);return t=t.getFullYear()+"年"+(t.getMonth()+1)+"月"+t.getDate()+"日",1==this.type||3==this.type?t+="过期":2==this.type&&(t+="已使用"),t},getDay:function(e){return parseInt((e-(new Date).getTime())/864e5)},showList:function(){this.collectionArr=[],this.setUrl(),this.fetch({reset:!0})},clearCache:function(){s.removeItem("receiptCollection")}})),r=i.Model.extend();t.ReceiptCollection=l,t.ParamModel=r},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@~1.12.0/js/pages/receiptlist",["zepto-wepp@~1.1.0","underscore@~1.5.0","marionette@~1.4.0","../modules/receiptlist/list/controller","../modules/receiptlist/layout.html"],function(e,t){var i,s=(e("zepto-wepp"),e("underscore")),n=e("marionette"),l=e("../modules/receiptlist/list/controller"),r=n.Controller.extend({show:function(){var t=this;ThisApp.openPage().then(function(i){i.initRegion({template:s.template(e("../modules/receiptlist/layout.html")),regions:{header:"header",list:".receipt-list"}}),t.renderList(i)},function(){i&&i.restart()})},renderList:function(e){i=new l({type:1,page:e}),i.show(e.layout.list)}});t.Controller=r},{asyncDeps:["iscroll@~5.0.9"]});