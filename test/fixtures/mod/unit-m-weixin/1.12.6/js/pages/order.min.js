define("unit-m-weixin@1.12.6/js/modules/order/content/controller",["./view","marionette@~1.4.0","zepto-wepp@~1.1.0","cookie@~0.1.0","underscore@~1.5.0","../../../entities/order"],function(e,t,i){var n=e("./view"),r=e("marionette"),o=(e("zepto-wepp"),e("cookie")),a=e("underscore");i.exports=r.Controller.extend({initialize:function(e){this.dealId=e.dealId||0,this.groupId=e.groupId||0},show:function(t){var i=this;this.OrderModel=e("../../../entities/order").OrderModel,this.orderModel=new this.OrderModel({groupId:this.groupId,dealId:this.dealId}),this.getView(),this.orderModel.on("change",a.bind(function(){t.show(i.getView()),this.view.dataInit()},this))},getView:function(){var e=o("_thirdu.c")||!1;return this.orderModel.set("wCookie",e),this.view=new n({model:this.orderModel}),this.view}})},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@1.12.6/js/modules/order/layout.html",[],function(e,t,i){i.exports='<div class="J_cnt"><div class="loading" style="height:200px;"></div></div>'},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@1.12.6/js/modules/order/content/view",["wepp@~2.7.0","backbone@~1.1.0","zepto-wepp@~1.1.0","marionette@~1.4.0","underscore@~1.5.0","./template.html","../../../entities/getuserprofilegn","../../../entities/deliverylist"],function(e,t,i){var n=e("wepp"),r=n.UI,o=e("backbone"),a=new o.Router,s=e("zepto-wepp"),l=e("marionette"),d=e("underscore");i.exports=l.ItemView.extend({template:d.template(e("./template.html")),tagName:"div",events:{"click .J_order_submit":"checkForm","touchstart .J_count_delete":"priceOp","touchstart .J_count_add":"priceOp","click .J_deliver_save":"saveOrderInfo","blur .J_order_unbind_phone":"phoneEdit","touchstart .J_order_getCaptcha":"sendCaptch"},initialize:function(){this.cityId=n.Module.City.getId(),this.UserProfilegnModel=e("../../../entities/getuserprofilegn").UserModel,this.userProfilegnModel=new this.UserProfilegnModel,this.isDeliver=2==this.model.get("dealType")?!0:!1,this.userProfilegnModel.on("change",d.bind(function(){this.getUserInfo()},this))},phoneEdit:function(){s(".J_order_unbind_phone").attr("data",s(".J_order_unbind_phone").val())},saveOrderInfo:function(e){e.preventDefault();var t=this.model;localStorage.setItem("orderInfo",JSON.stringify({gId:t.get("groupId"),dId:t.get("dealId")})),a.navigate("#deliverylist",!0)},priceOp:function(e){e.preventDefault();var t=this.model,i=s(e.currentTarget),n=s(".J_total_price"),r=s(".J_total_count"),o=s(".J_count_add"),a=s(".J_count_delete"),l=parseFloat(n.html()),d=parseFloat(t.get("price")),c=parseInt(r.val()),u=t.get("minCount"),p=t.get("maxCount");return i.hasClass("J_count_delete")&&parseInt(r.val())<u?!1:i.hasClass("J_count_add")&&0!=p&&parseInt(r.val())>p?!1:(s(n).html(i.hasClass("J_count_delete")?l-d>0?parseFloat(l-d).toFixed(2):parseFloat(d).toFixed(2):i.hasClass("J_count_add")?parseFloat(l+d).toFixed(2):l),s(r).val(i.hasClass("J_count_delete")?c-1>0?c-1:c:i.hasClass("J_count_add")?c+1:c),o.removeClass("n-bytn"),a.removeClass("n-btn"),void(i.hasClass("J_count_delete")&&parseInt(r.val())==u?a.addClass("n-btn"):i.hasClass("J_count_add")&&0!=p&&parseInt(r.val())==p&&o.addClass("n-btn")))},sendOrder:function(){var e=this.model,t=this;s(".J_order_submit").addClass("hide"),s(".J_un_order_submit").removeClass("hide");var i={groupid:e.get("groupId"),dealid:e.get("dealId"),cityid:t.cityId,phoneNo:t.phoneNo||"",count:t.count,paymentamount:t.paymentamount,callid:"",deliveryid:t.deleveryData&&t.deleveryData.id||"",deliverytype:s(".J_delivery_type").val(),orderId:"0",memo:s(".J_order_text").val().trim(),invoicetitle:(s(".J_order_receipt").val()||"").trim(),cardid:"",productid:"",source:"",ismembercard:"0",channel:"weixin",utm:""|n.Url.get("utm")},o=(parseFloat(t.userProfilegnModel.get("balance")),parseFloat(t.paymentamount));s.ajax({url:3!=e.get("dealType")?"/ajax/tuan/createordergn.json?"+(new Date).valueOf():"/ajax/tuan/submitLotterygn.json?"+(new Date).valueOf(),data:i,type:"POST",dataType:"json",success:function(i){var n=i.data||{};s(".J_order_submit").removeClass("hide"),s(".J_un_order_submit").addClass("hide"),200==i.code?3==e.get("dealType")?(localStorage.setItem("lottery",n.content),a.navigate("#paysuc~lottery",!0)):(localStorage.setItem("orderConfirm",JSON.stringify({orderId:n.orderId,title:e.get("title"),price:e.get("price"),groupId:e.get("groupId"),count:t.count,dealId:e.get("dealId"),canUseBalance:e.get("canUseBalance"),canUseDiscount:e.get("canUseDiscount"),paymentamount:o,paymentType:n.paymentType,userId:t.userProfilegnModel.get("userId"),shortTitle:e.get("shortTitle"),discountList:n.discountList||[],cityId:t.cityId})),location.href=location.search?-1==location.search.indexOf("showwxpaytitle")?location.search+"&showwxpaytitle=1#orderconfirm~"+n.orderId:"#orderconfirm~"+n.orderId:"?showwxpaytitle=1#orderconfirm~"+n.orderId):r.alert(n.content)}})},checkForm:function(e){function t(){var e=s(".J_code_input").val().trim();return i.phoneNo=s(".J_order_unbind_phone").val().trim(),/^1\d{10}$/.test(i.phoneNo)?e?{mobile:i.phoneNo,vcode:e}:(r.alert("验证码不能为空"),!1):(r.alert("无效手机号"),!1)}var i=this,n=i.model;e.preventDefault();var o=n.get("isThird"),a=3==n.get("dealType"),l=0==n.get("price");if(!i.unLogin&&i.isDeliver&&!i.deleveryData)return r.alert("请选择配送信息"),!1;if(this.count=parseInt(s(".J_total_count").val()),this.paymentamount=parseFloat(s(".J_total_price").html()),i.unLogin){var d,c,u=n.get("wCookie");if(u&&(o||a||l)){if(d="/ajax/account/mobiledynamiclogin/3",c=t(),!c)return}else if(u)!u||o||a||l||(d="/ajax/account/thirdpartlogin",c={});else if(d="/ajax/account/mobiledynamiclogin/2",c=t(),!c)return;s(".J_order_submit").addClass("hide"),s(".J_un_order_submit").removeClass("hide"),s.ajax({url:d,data:c,type:"POST",dataType:"json",success:function(e){return 200!=e.code?(r.alert(e.msg&&e.msg.err),s(".J_order_submit").removeClass("hide"),s(".J_un_order_submit").addClass("hide"),!1):void(i.isDeliver?location.reload():i.sendOrder.call(i,arguments[0]))}})}else{if((o||a||l)&&!i.checkPhone(s(".J_order_bind_phone").attr("data")))return r.alert("无效手机号"),!1;this.phoneNo=s(".J_order_bind_phone").attr("data")||"",i.sendOrder.call(i,arguments[0])}},showDealInfo:function(){var t=this,i=this.model;if(2==i.get("status")&&(s(".J_un_order_submit").removeClass("hide").html("已卖光"),s(".J_order_submit").addClass("hide")),t.isDeliver){t.UserDeliveryListModel=e("../../../entities/deliverylist").DeliveryModel;var n=t.userDeliveryListModel=new t.UserDeliveryListModel;n.on("change",d.bind(function(){t.isDeliver&&s(".J_order_delivery").removeClass("hide"),t.deliveryUpdate(n.get("indexSelected")),t.iscrollInstance&&t.iscrollInstance.refresh()},t)),ThisApp.commands.setHandler("order::delivery::update",function(e){t.deliveryUpdate(e)}),ThisApp.commands.setHandler("order::deliveryList::add",function(e){n.set("list",e),s(".J_delivey_alert").html("更改收货地址")})}else t.iscrollInstance&&t.iscrollInstance.refresh()},deliveryUpdate:function(e){var t=this.userDeliveryListModel,i=t.get("list")&&t.get("list")[e];return i?(s(".J_delivey_order").removeClass("hide").html('<div class="item">'+i.receiver+"&nbsp;&nbsp;"+i.phoneNo+" <br>"+i.showAddress+"<br>"+i.postCode+"</div>"),t.set("indexSelected",e),void(this.deleveryData=i)):(s(".J_delivey_order").html(""),s(".J_delivey_alert").html("添加新地址"),!1)},getUserInfo:function(){var e=this,t=this.userProfilegnModel,i=this.model,n=i.get("isThird"),r=3==i.get("dealType"),o=0==i.get("price"),a=i.get("wCookie"),l=s(".J_phone_title");if(200==t.get("code")){s(".J_order_un_login").addClass("hide"),s(".J_order_login").removeClass("hide");var d=t.get("phone");l.html("您绑定的手机号"),d?(l.removeClass("hide"),s(".J_order_bind_phone").attr({data:d,readonly:!0}).html('手机号：<input type="text" class="nolog-input " placeholder="填写手机号码" value="'+d.replace(/\d{3}(\d{4})/,function(e){return e.substr(0,3)+"****"})+'">')):n||r||o?(ThisApp.commands.setHandler("order::phone::update",function(t){s(".J_order_bind_phone").removeClass("no-p").attr({data:t,readonly:!0}).html('手机号：<input type="text" class="nolog-input " placeholder="填写手机号码" value="'+t.replace(/\d{3}(\d{4})/,function(e){return e.substr(0,3)+"****"})+'">'),e.phoneNo=t}),s(".J_order_bind_phone").addClass("no-p").html('<a class="fill arrow" href="#bindphone~g_'+i.get("groupId")+"~d_"+i.get("dealId")+'"> <span class="info">请绑定手机号</span> <i class="arrow-ent right d"></i> </a>'),l.removeClass("hide")):l.parent().hide(),e.showDealInfo()}else{if(e.unLogin=!0,s(".J_order_delivery").addClass("hide"),!a||a&&(n||r||o))l.removeClass("hide"),s(".J_order_un_login").removeClass("hide");else{s(".J_order_un_login").addClass("hide");var c=encodeURIComponent(location.href),u=-1!==location.host.indexOf("51ping")?"http://m.51ping.com/":"http://m.dianping.com/",p=u+"bind?redir="+c;l.html('<a href="'+p+'">绑定已有点评账号</a>').removeClass("hide")}e.iscrollInstance&&e.iscrollInstance.refresh()}},checkPhone:function(e){return/^1\d{10}$/.test(parseInt(e))},dataInit:function(){var e=this.model;this.count=e.get("minCount")},sendCaptch:function(){var e=s(".J_order_unbind_phone").val(),t=this,i=this.model;/^1\d{10}$/.test(e)?(s(".J_order_unbind_phone").attr("readonly",!0),s.ajax({url:i.get("wCookie")?"/ajax/account/mobiledynamiclogincode/3":"/ajax/account/mobiledynamiclogincode/2",data:{mobile:e},type:"POST",dataType:"json",success:function(e){e.data;200==e.code?(t._timeout(),r.alert("验证码已发送"),s(".J_order_verify_code").removeClass("hide")):(r.alert(e.msg&&e.msg.err||"验证码发送失败"),s(".J_order_unbind_phone").removeAttr("readonly"))}})):r.alert("无效手机号")},_timeout:function(){s(".J_order_getCaptcha").addClass("hide"),s(".J_order_getCaptcha_ing").removeClass("hide").html("60秒后重发"),self.timer=setInterval(function(){var e=parseInt(s(".J_order_getCaptcha_ing").html());1==e&&(clearInterval(self.timer),s(".J_order_getCaptcha_ing").addClass("hide"),s(".J_order_getCaptcha").removeClass("hide"),s(".J_order_unbind_phone").removeAttr("readonly")),s(".J_order_getCaptcha_ing").html(e-1+"秒后重发")},1e3)}})},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@1.12.6/js/entities/order",["backbone@~1.1.0","./city"],function(e,t){var i=e("backbone"),n=i.Model.extend({baseUrl:"/ajax/tuan/dealgn.json?",initialize:function(e){this.set(e),this.setUrl(),this.fetch()},parse:function(e){var t=this,i=e.data;return result=i.dealSelects&&i.dealSelects.filter(function(e){return t.get("dealId")&&e.id==t.get("dealId")?!0:!1})[0]||{},{title:result.title||"",price:result.priceStr||-0,minCount:i.buyMixCount,total:parseFloat(parseInt(i.buyMixCount)*parseFloat(result.priceStr)).toFixed(2),deliveryType:i.deliveryType,dealType:result.dealType,maxCount:i.buyLimit,dealId:result.id,groupId:t.get("groupId"),dealSelects:i.dealSelects,shortTitle:i.shortTitle,canUseBalance:i.canUseBalance,canUseDiscount:i.canUseDiscount,status:result.status,refund:i.refund,hasReceipt:i.hasReceipt,isThird:i.isThirdParty,isLimitPerUser:i.isLimitPerUser}},setUrl:function(){var t=e("./city");this.url=this.baseUrl+"id="+this.get("groupId")+"&cityid="+t.getId()}});t.OrderModel=n},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@1.12.6/js/modules/order/content/template.html",[],function(e,t,i){i.exports='<div class="Box"><div class="order-box order-info"><ul><li class="item-cls"><span class="infor"><%= title %></span><%if(minCount != 1 || isLimitPerUser){%><div class="o-alert"><%if(minCount != 1){%>  至少买<%= minCount %>份<%}%> <%if(isLimitPerUser){%>最多可买<%= maxCount %>份<%}%></div><%}%></li><% if(dealType != 3){%><li>单价：<span class="infor Right" id="J_price">¥<%= price %></span></li><li>数量：<span class="Right"><a onclick="ThisApp.mv({module:\'order_reducenum\'})" class="num-operating J_count_delete y-btn n-btn"  href="javascript:void(0)" data-min="1">-</a><input id="J_amount" readonly type="text" name="quantity" autocomplete="off" maxlength="5" value="<%= minCount %>" class="s-input J_total_count"><a onclick="ThisApp.mv({module:\'order_addnum\'})" class="noDirect num-operating plus J_count_add y-btn" href="javascript:void(0)" data-max="9999" data-maxperuser="0" >+</a></span></li><li>总价：<span class="Right"><strong>¥</strong> <strong class="price J_total_price"><%= total %></strong></span> </li><li class="refund"><span class="support Left"><% if(refund){%><i class="icon-s"></i>支持随时退</span><span class="support Left"><i class="icon-s"></i>支持过期退</span><%}else{%><i class="icon-e"></i>不支持随时退</span><span class="support Left"><i class="icon-e"></i>不支持过期退</span><%}%></li><%}%></ul></div></div><div class="Box"><h5 class="J_phone_title hide">请输入您的手机号<b style="color:red">*</b> <% if(wCookie){ %>或 <a onlick="ThisApp.mv({module:\'order_login\'})" href="<%  var _location = encodeURIComponent(location.href); if(location.host.indexOf(\'51ping\')!==-1){%>  http://m.51ping.com/bind?redir=<%= _location %> <%}else{%>http://m.dianping.com/bind?redir=<%= _location %><%}%>">绑定已有点评账号</a><%}%></h5><div class="order-box"><ul class="J_order_un_login hide"><li class="J_order_phone"><span class="infor">手机号&nbsp;</span><input id="J_phoneNum" class="nolog-input J_order_unbind_phone" style="width:40%" placeholder="请输入手机号" type="text" name="mobile"><a class="s-btn Right J_order_getCaptcha"  href="javascript:void(0)">获取验证码</a><a class="g-btn Right J_order_getCaptcha_ing hide"  href="javascript:void(0)"></a></li><li class="J_order_verify_code"><span class="infor">验证码&nbsp;</span><input class="nolog-input J_code_input" placeholder="请输入验证码" type="text" name="mobile"></li></ul><ul class="J_order_login hide"><li class="J_order_bind_phone"></li></ul></div></div><div class="Box J_order_delivery hide"><h5>收货地址</h5><div class="order-box"><ul><li class="J_delivey_order hide"></li><li class="no-p"><a class="fill arrow J_deliver_save" href="javascript:void(0)"><span class="info J_delivey_alert">更改收货地址</span><i class="arrow-ent right"></i></a></li></ul></div></br><h5>配送要求</h5><div class="nom-box"><select class="test-select J_delivery_type" name="deliverTime"><%_.each(deliveryType,function(item){%><option value="<%= item.id %>"><%= item.name %></option><% }); %></select></div><br/><div class="order-box"><ul><li class=""><span class="infor">备注：</span><input id="" class="nolog-input J_order_text" style="width:60%" placeholder="在此填写特殊配送要求" type="text" name="mobile"></li><% if(hasReceipt){ %><li><span class="infor">发票抬头：</span><input id="" class="nolog-input J_order_receipt" style="width:60%" placeholder="在此填发票抬头" type="text" name="mobile"></li><%}%></ul></div></div><div class="Box"><a onclick="ThisApp.mv({module:\'order_submit\'})" href="javascript:void(0)" id="J_order_submit" type="submit" class="y-btn  J_order_submit" name=""  style="width:95%;margin:0 auto;">提交订单</a><a href="javascript:void(0)" id="J_un_order_submit" type="submit" class="n-btn  hide J_un_order_submit" name=""  style="width:95%;margin:0 auto;">正在处理</a></div><div style="height:50px;width:100%"></div>'},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@1.12.6/js/entities/getuserprofilegn",["backbone@~1.1.0"],function(e,t){var i=e("backbone"),n=i.Model.extend({url:"/ajax/tuan/tuanprofilegn.json?",initialize:function(){this.fetch()},parse:function(e){var t=e.data;return{phone:t.mobilePhone,userId:t.userId,balance:t.balance,nickName:t.nickName,couponCount:t.couponCount,receiptCount:t.unusedReceiptCount,orderCount:t.unpayedOrderCount,code:e.code}}});t.UserModel=n},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@1.12.6/js/entities/deliverylist",["backbone@~1.1.0","underscore@~1.5.0"],function(e,t){var i=e("backbone"),n=e("underscore"),r=i.Model.extend({url:"/ajax/tuan/deliverylistgn.json?",initialize:function(){this.fetch()},parse:function(e){var t=e.data,i=t.list&&t.list.length?localStorage.deliveryIndex||0:-1;return t.list=t.list||[],n.extend(t,{indexSelected:i})}});t.DeliveryModel=r},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@1.12.6/js/entities/city",["wepp@~2.7.0","backbone@~1.1.0","underscore@~1.5.0"],function(e,t,i){var n=e("wepp").Url,r=e("backbone"),o=e("underscore"),a={ID:"cityid",ENNAME:"cityenname",NAME:"cityname"},s=!0,l={getId:function(){var e=n.get(a.ID);return s&&null!==e?(localStorage.setItem(a.ID,e),e):localStorage.getItem(a.ID)||1},getEnName:function(){var e=n.get(a.ENNAME);return s&&null!==e?(localStorage.setItem(a.ENNAME,e),e):localStorage.getItem(a.ENNAME)||"shanghai"},getName:function(){var e=n.get(a.NAME);return s&&null!==e?(localStorage.setItem(a.NAME,e),e):localStorage.getItem(a.NAME)||"上海"},setId:function(e){localStorage.setItem(a.ID,e),s=!1},setEnName:function(e){localStorage.setItem(a.ENNAME,e),s=!1},setName:function(e){localStorage.setItem(a.NAME,e),s=!1},set:function(e){e.id&&this.setId(e.id),e.enname&&this.setEnName(e.enname),e.name&&this.setName(e.name),this.trigger("change")}};o.extend(l,r.Events),i.exports=l},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@1.12.6/js/pages/order",["zepto-wepp@~1.1.0","underscore@~1.5.0","marionette@~1.4.0","../modules/order/content/controller","../modules/order/layout.html"],function(e,t){var i=(e("zepto-wepp"),e("underscore")),n=e("marionette"),r=e("../modules/order/content/controller"),o=n.Controller.extend({show:function(t,n){var o=this;o.contentController=new r({groupId:t,dealId:n}),ThisApp.openPage().then(function(t){t.initRegion({template:i.template(e("../modules/order/layout.html")),regions:{header:".J_header",content:".J_cnt"}}),o.contentController.show(t.layout.content)})}});t.Controller=o},{asyncDeps:["iscroll@~5.0.9"]});