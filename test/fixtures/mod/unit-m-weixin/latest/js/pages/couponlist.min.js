define("unit-m-weixin@latest/js/modules/couponlist/list/controller",["marionette@~1.4.0","backbone@~1.1.0","./template.html","zepto-wepp@~1.1.0","underscore@~1.5.0","../../../entities/couponlist"],function(e,t,i){var n=e("marionette"),o=e("backbone").View.extend({template:e("./template.html"),tagName:"ul"}),s=e("zepto-wepp"),l=e("underscore"),a=e("../../../entities/couponlist");i.exports=n.Controller.extend({initialize:function(e){function t(){c=d.region.$el.get(0).offsetHeight}var i=this.page=e.page;delete e.page,this.paramModel=new a.ParamModel(e);var n=this.collection=new a.CouponCollection(this.paramModel),r=this.view=new o({collection:n}),d=this,c=0;n.on("reset",function(){var e=d.region.$el;if(!n.models.length)return void e.html('<p class="msg" style="text-align:center;padding-top:20px;">您没有未使用的抵用券</p>');var i="";n.toJSON().forEach(function(e){i+=l.template(r.template,e)}),r.$el.append(i),e.empty().append(r.$el),t()});var p=s(window);p.on("scroll",function(){ThisApp.pageRegion.isCurrentPage(i)&&p.scrollTop()+p.height()>c-60&&(console.log("more"),d.more())}),this.listenToNext()},show:function(e){this.region=e,e.ensureEl()},isEnd:function(){return this._isEnd},next:function(){return this._next},listenToNext:function(){this.collection.on("sync",l.bind(function(e,t){this._isEnd=t.data.isEnd,this._next=t.data.nextStartIndex},this))},more:function(){if(!this.isEnd()){this.showLoadingText();var e=this.collection.paramModel;e.set({start:this.next()})}},showLoading:function(){this.view.$el.find(".more-loading").removeClass("hide")},hideLoading:function(){this.view.$el.find(".more-loading").addClass("hide")},hideLoadingText:function(){this.view.$el.find(".more-loading").html("")},showLoadingText:function(){this.view.$el.find(".more-loading").html("正在加载...")},toggleLoading:function(){this.isEnd()?this.hideLoading():this.showLoading()},initLoading:function(){var e=this.view.$el;e.find(".more-loading").length||e.append('<div class="more-loading hide"><div>正在加载...</div></div>')}})},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@latest/js/modules/couponlist/layout.html",[],function(e,t,i){i.exports='<div class="coupon-list"></div>'},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@latest/js/modules/couponlist/list/template.html",[],function(e,t,i){i.exports='<li><div class="coupon_bg">折抵<%=priceStr%> </div><div class="coupon_link" ><h3 class="title"><%= title %></h3><p class="coupon_time"><%=beginDate%>至<%=expiredDate%>有效</p></div></li>'},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@latest/js/entities/couponlist",["backbone@~1.1.0","underscore@~1.5.0"],function(e,t){var i=e("backbone"),n=e("underscore"),o=i.Model.extend({}),s=i.Collection.extend({initialize:function(e){this.paramModel=e,this.paramModel.on("change",n.bind(this.showList,this)),this.paramModel.trigger("change")},model:o,baseUrl:"/ajax/tuan/discountgn.json?",setUrl:function(){this.url=this.baseUrl+"start="+(this.paramModel.get("start")||0)+"&r="+Math.random()},parse:function(e){var t=this;if(200==e.code){var i=e.data.discountList||[];return i.map(function(e){return e.expiredDate=t.parseDate(e.expiredDate),e.beginDate=t.parseDate(e.beginDate),e})}401==e.code&&(window.location="")},showList:function(){this.setUrl(),this.fetch({reset:!0})},parseDate:function(e){var t=new Date(e),i=function(e){var t="0"+e;return t.substr(t.length-2)};return t.getFullYear()+"-"+i(t.getMonth()+1)+"-"+i(t.getDate())}}),l=i.Model.extend();t.CouponCollection=s,t.ParamModel=l},{asyncDeps:["iscroll@~5.0.9"]}),define("unit-m-weixin@latest/js/pages/couponlist",["zepto-wepp@~1.1.0","underscore@~1.5.0","marionette@~1.4.0","../modules/couponlist/list/controller","../modules/couponlist/layout.html"],function(e,t){var i=(e("zepto-wepp"),e("underscore")),n=e("marionette"),o=e("../modules/couponlist/list/controller"),s=n.Controller.extend({show:function(){ThisApp.openPage().then(function(t){t.initRegion({template:i.template(e("../modules/couponlist/layout.html")),regions:{list:".coupon-list"}});var n=new o({type:1,page:t});n.show(t.layout.list)})}});t.Controller=s},{asyncDeps:["iscroll@~5.0.9"]});